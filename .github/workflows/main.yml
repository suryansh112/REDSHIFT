name: Redshift-Workflow
on:
  workflow_dispatch:
    inputs:
      command: 
        description: Choose whether to apply or destroy
        required: true
        default: apply
        type: choice
        options:
        - apply
        - destroy
      environments:
        description: Choose Env
        required: true
        type: choice
        default: dev
        options:
        - dev
        - qa
        - prod
      region:
        description: Choose Region
        required: true
        type: choice
        default: us-east-1
        options:
        - ap-south-1
        - us-east-1
env:
  ROLE_NAME : ${{secrets.ROLE_NAME}}
permissions:
  id-token: write  
  contents: read
jobs:
  Dev_Redshift_Cluster:
    if: inputs.environments == 'dev'
    runs-on: ubuntu-latest
    steps:
    - name: Clone Repo
      uses: actions/checkout@main
    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{secrets.ROLE_NAME}} 
        role-session-name: GitHub_to_AWS_via_FederatedOIDC
        aws-region: ${{ inputs.region }}
    - name: Creating RedShift Cluster
      if: inputs.command == 'apply'
      run: |
           pwd
           terraform workspace new dev
           terraform init
           terraform plan -var="role=$ROLE_NAME" -var-file="dev.tfvars" -var="bucket=${{secrets.bucket_arn}}" -var="github_workspace=${GITHUB_WORKSPACE}" -var="redshift_lambda_access=${{secrets.REDSHIFT_LAMBDA_ACCESS}}" -var="region=${{inputs.region}}"
           terraform ${{inputs.command}} --auto-approve -var="role=$ROLE_NAME" -var-file="dev.tfvars" -var="bucket=${{secrets.bucket_arn}}" -var="github_workspace=${GITHUB_WORKSPACE}" -var="redshift_lambda_access=${{secrets.REDSHIFT_LAMBDA_ACCESS}}" -var="region=${{inputs.region}}"
    - name: Destroying Redshift Cluster
      if: inputs.command == 'destroy'
      run: |
           terraform workspace new dev
           terraform init
           terraform plan -var="role=$ROLE_NAME" -var-file="dev.tfvars" -var="bucket=${{secrets.bucket_arn}}" -var="github_workspace=${GITHUB_WORKSPACE}" -var="redshift_lambda_access=${{secrets.REDSHIFT_LAMBDA_ACCESS}}" -var="region=${{inputs.region}}"
           terraform ${{inputs.command}} --auto-approve -var="role=$ROLE_NAME" -var-file="dev.tfvars" -var="bucket=${{secrets.bucket_arn}}" -var="github_workspace=${GITHUB_WORKSPACE}" -var="redshift_lambda_access=${{secrets.REDSHIFT_LAMBDA_ACCESS}}" -var="region=${{inputs.region}}"